FIAS SmartПоиск — адресный поиск с донастройкой релевантности
============================================================

Этот репозиторий содержит API и фронтенд для интерактивного поиска адресов на базе ФИАС и Elasticsearch. Проект настроен для быстрой итеративной докрутки релевантности (SmartПоиск): вы присылаете проблемные запросы, мы фиксируем, правим ранжирование/нормализацию и оперативно проверяем, не сломались ли уже «рабочие» кейсы.

Ссылки окружения (сервер)
-------------------------
- Интерфейс (frontend): `http://<HOST>:8080/` (в проде сейчас: `http://147.45.214.115:8080/`)
- API (backend): `http://<HOST>:8000/`
  - Документация Swagger: `http://<HOST>:8000/docs`
  - Health: `http://<HOST>:8000/health`

Архитектура и директории
-------------------------
- `fias_project/api/` — серверная часть (FastAPI)
  - `main.py` — входная точка API
  - `search.py` — логика формирования ES-запросов и ранжирования
  - `normalizer.py` — нормализация текста запроса и разбор дома/корпуса/строения
  - `models.py` — модели ответов API
- `fias_project/frontend/` — статический фронтенд (vanilla HTML/JS)
  - `index.html` — UI, динамически указывает на текущий API: `API_BASE = ${location.protocol}//${location.hostname}:8000`
- `fias_project/config/` — конфигурация API/ES
- `fias_project/data/` — вспомогательные скрипты/метрики
- `fias_project/tests/` и `test_*.py` — вспомогательные локальные проверки
- `fias_project/queries/` — реестры запросов для процесса докрутки релевантности
  - `working.md` — подтверждённые «рабочие» кейсы
  - `pending.md` — текущие проблемные кейсы для работы
  - `tests.json` — автоматизированная система тестирования

Технический стек
----------------
- Python 3.10+
- FastAPI + Uvicorn
- Elasticsearch 8+

Быстрый запуск (локально)
-------------------------
1) Установить зависимости:
```
pip install -r requirements.txt
```

2) Запустить API с авто‑перезагрузкой:
```
# ВАЖНО: Запускать из директории fias_project, а не из корня!
cd fias_project
python -m uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload
```

**КРИТИЧНО**: API ДОЛЖЕН запускаться из директории `fias_project`, а не из корня проекта!
Если запускать из корня, возникнет ошибка `ModuleNotFoundError: No module named 'api'`.

**ВАЖНО**: Убедитесь, что на порту 8000 запущен только ОДИН процесс API. Если запущено несколько процессов, 
может возникнуть конфликт и API будет использовать старую версию кода.

**ИСПРАВЛЕНО**: Проблема с разбиением "Московская" на "московс ая" в нормализаторе. 
Исправлены регулярные выражения в `api/normalizer.py` для корректной обработки окончаний прилагательных.

3) Запустить фронтенд (любой статик-сервер), пример на Python:
```
python3 -m http.server 8080 --directory fias_project/frontend
```

4) Открыть UI: `http://localhost:8080/`

**Примечание**: Если API не запускается с ошибкой `ModuleNotFoundError: No module named 'fias_project'`, 
убедитесь, что вы запускаете команду из директории `fias_project`, а не из корня проекта.

Как это работает
----------------
- **Веб-интерфейс**: Двухпанельный макет с левой панелью для тестов и правой для поиска
- **API**: RESTful API с автоматизированной системой тестирования
- **Нормализация** (`normalizer.py`):
  - Приведение к канонам типов (ул/пр-кт/пл/ш и т.п.)
  - Разбор `дом/к/стр` (поддержка форм «37с5», «49к4с2», «вл 10»)
  - Возвращает `text_without_house`, `house_number`, `korpus`, `stroenie`
- **Поиск** (`search.py`):
  - Сборка `bool` запроса в ES с набором `must/should/filter`
  - Точные фразы по `name_norm/name_exact/full_norm`
  - Доп. бусты типов (пл/ш/пр-кт/пос и др.) и приоритизация Москвы (`region_code=77`) при наличии в запросе
  - Усиленные правила для дома/строения, включая случаи, когда «стр 5» хранится в `korpus`

Порты и процессы
----------------
- API: 8000 (Uvicorn, можно запускать с `--reload`)
- Frontend: 8080 (любой статик-сервер)
- Elasticsearch: 9200 (см. `config` и `INTEGRATION_GUIDE.md`)

Интеграция с Elasticsearch
--------------------------
Подробная инструкция по настройке подключения Background Agent к Elasticsearch:
- **Основная инструкция**: `INTEGRATION_GUIDE.md`
- **Тестирование подключения**: `./test_elasticsearch_connection.sh`
- **Настройка безопасности**: `./setup_elasticsearch_security.sh`
- **Конфигурация Cursor**: `.cursor/environment.json`
- **Пример переменных**: `env.example`

**Текущее состояние**: Elasticsearch доступен по адресу `http://147.45.214.115:9200` без аутентификации.

Процесс работы (SmartПоиск)
---------------------------
Цель — быстро доводить релевантность до идеала по реальным запросам.

### Автоматизированная система тестирования
- **Веб-интерфейс**: `http://147.45.214.115:8080/` - двухпанельный интерфейс
  - Левая панель: управление тестами с прокруткой
  - Правая панель: поиск адресов (фиксированная)
- **Кликабельные запросы**: клик по запросу в таблице автоматически выполняет поиск
- **Добавление тестов списком**: вставьте несколько адресов в textarea
- **Автоматическая проверка**: система сама сравнивает ожидаемые и фактические ответы

### Алгоритм работы
1) **Обработка по 2 запроса**: берем максимум 2 проблемных запроса за раз
2) **Исправление**: анализируем, правим `normalizer.py`/`search.py`
3) **Перенос**: исправленные запросы перемещаем в рабочие
4) **Регрессия**: проверяем все рабочие запросы
5) **Откат**: если что-то сломалось - возвращаем в проблемные

### Файлы системы
- `fias_project/queries/working.md` — подтверждённые «рабочие» кейсы
- `fias_project/queries/pending.md` — текущие проблемные кейсы
- `fias_project/queries/tests.json` — автоматизированная система тестирования

Полезные эндпоинты API
----------------------
- **Поиск**: `GET /search?q=...&limit=10`
- **Анализ нормализации**: `GET /analyze?q=...`
- **Здоровье**: `GET /health`
- **Тесты**: `GET /tests` - получение списка тестов
- **Добавление теста**: `POST /tests` - добавление нового теста
- **Запуск тестов**: `POST /tests/run` - выполнение всех тестов
- **Удаление теста**: `DELETE /tests/{id}` - удаление теста

Важно: работа с кириллическими запросами
---------------------------------------
При тестировании API через curl или другие HTTP-клиенты с кириллическими запросами **обязательно** используйте правильное URL-кодирование:

**✅ ПРАВИЛЬНО:**
```bash
# Автоматическое кодирование с кавычками
curl -s "http://localhost:8000/search?q=Москва, Варшавское ш., 37с5&limit=5"

# Или ручное URL-кодирование
curl -s "http://localhost:8000/search?q=%D0%9C%D0%BE%D1%81%D0%BA%D0%B2%D0%B0%2C%20%D0%92%D0%B0%D1%80%D1%88%D0%B0%D0%B2%D1%81%D0%BA%D0%BE%D0%B5%20%D1%88.%2C%2037%D1%815&limit=5"

# Тестирование нормализации
curl -s "http://localhost:8000/analyze?q=Москва, Варшавское ш., 37с5"
```

**❌ НЕПРАВИЛЬНО:**
```bash
# Без кавычек или неправильное кодирование приведет к ошибкам
curl -s http://localhost:8000/search?q=Москва, Варшавское ш., 37с5&limit=5
curl -s "http://localhost:8000/search?q=Москва%2C%20Варшавское%20ш.%2C%2037с5&limit=5"  # неполное кодирование
```

**Типичные ошибки:**
- `Invalid HTTP request received` — неправильное URL-кодирование
- Пустой ответ — проблемы с кодировкой параметров
- `parse error: Invalid numeric literal` — проблемы с jq при неправильном JSON

Частые команды
--------------
```
cd fias_project
python -m uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload
python3 -m http.server 8080 --directory fias_project/frontend
```

Отладка и логирование
---------------------
- **Логи API**: API автоматически логирует все запросы в консоль при запуске с `--reload`
- **Логи Elasticsearch**: API логирует все запросы к Elasticsearch в консоль
- **Отладка поиска**: В логах можно увидеть SQL-запросы к Elasticsearch для отладки
- **Проверка здоровья**: `curl http://localhost:8000/health` - проверка статуса API
- **Проверка Elasticsearch**: API автоматически проверяет подключение к ES при запуске

**Почему API может перестать работать:**
1. **Синтаксические ошибки в коде** - API не запустится, если есть ошибки в Python-коде
2. **Проблемы с Elasticsearch** - если ES недоступен, API может не отвечать
3. **Проблемы с портами** - если порт 8000 занят другим процессом
4. **Проблемы с зависимостями** - если не установлены все required пакеты

**Как диагностировать проблемы:**
1. Проверьте логи в консоли, где запущен API
2. Проверьте статус Elasticsearch: `curl http://localhost:9200/_cat/health`
3. Проверьте статус API: `curl http://localhost:8000/health`
4. Перезапустите API с флагом `--reload` для автоматической перезагрузки при изменениях

С чего начинать новому чату
---------------------------
1) **Прочитать этот README** и понять архитектуру системы
2) **Открыть веб-интерфейс**: `http://147.45.214.115:8080/`
   - Изучить двухпанельный интерфейс
   - Проверить работу кликабельных запросов
   - Запустить тесты через кнопку "▶️ Запустить тесты"
3) **Проверить API**: `http://147.45.214.115:8000/health`
4) **Изучить текущие тесты**: через веб-интерфейс или API `/tests`
5) **Работать по алгоритму**:
   - Брать максимум 2 проблемных запроса
   - Исправлять через `api/search.py` и/или `api/normalizer.py`
   - Переносить исправленные в рабочие
   - Проводить регрессию по всем рабочим
   - Откатывать сломанные обратно в проблемные
6) **Использовать автоматизацию**:
   - Добавлять новые тесты списком через веб-интерфейс
   - Кликать по запросам для быстрой проверки
   - Запускать массовую проверку через "▶️ Запустить тесты"


